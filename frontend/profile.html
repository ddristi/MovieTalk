<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

    <!-- Logged-in Navbar -->
    <nav id="loggedInNavbar"
        class="sticky top-0 z-50 w-full bg-white/80 backdrop-blur-md shadow-md transition-all duration-300">
        <div class="max-w-7xl mx-auto flex justify-between items-center px-4 py-2">
            <a href="/" class="flex items-center space-x-2">
                <img src="https://assets.aceternity.com/logo-dark.png" alt="logo" class="w-8 h-8">
                <span class="font-bold text-black">MovieTalk</span>
            </a>

            <div class="hidden lg:flex items-center space-x-4">
                <a href="/" class="px-3 py-2 rounded hover:bg-gray-200">Home</a>
                <a href="/myreview.html" class="px-3 py-2 rounded hover:bg-gray-200">My Reviews</a>

                <!-- Profile Dropdown -->
                <div class="relative">
                    <button id="profileButton"
                        class="w-10 h-10 rounded-full overflow-hidden border-2 border-gray-300 focus:outline-none">
                        <img src="https://i.pravatar.cc/100?img=12" alt="Profile" class="w-full h-full object-cover">
                    </button>
                    <div id="profileDropdown"
                        class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg">
                        <a href="/profile.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Profile</a>
                        <hr class="border-gray-200">
                        <a id="logoutButton" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Logout</a>
                    </div>
                </div>
            </div>

            <!-- Mobile Menu -->
            <button id="loggedInMobileMenuButton" class="lg:hidden px-3 py-2 rounded bg-gray-200">â˜°</button>
        </div>

        <div id="loggedInMobileMenu" class="hidden flex-col px-4 py-2 space-y-2 bg-white shadow-md lg:hidden">
            <a href="/" class="px-3 py-2 rounded hover:bg-gray-200">Home</a>
            <a href="/myreview.html" class="px-3 py-2 rounded hover:bg-gray-200">My Reviews</a>
            <a href="/profile.html" class="px-3 py-2 rounded hover:bg-gray-200">Profile</a>
            <a id="logoutButton" class="px-3 py-2 rounded hover:bg-gray-200">Logout</a>
        </div>
    </nav>

    <script>
        const button = document.getElementById('loggedInMobileMenuButton');
        const menu = document.getElementById('loggedInMobileMenu');
        button.addEventListener('click', () => menu.classList.toggle('hidden'));

        const profileButton = document.getElementById('profileButton');
        const profileDropdown = document.getElementById('profileDropdown');
        profileButton.addEventListener('click', () => profileDropdown.classList.toggle('hidden'));
        document.addEventListener('click', (e) => {
            if (!profileButton.contains(e.target) && !profileDropdown.contains(e.target)) {
                profileDropdown.classList.add('hidden');
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const loggedInNavbar = document.getElementById("loggedInNavbar");
            const profilePhoto = document.querySelector("#profileButton img")

            let user = null;

            try {
                const response = await fetch("http://localhost:3000/api/v1/user/current-user", {
                    method: "GET",
                    credentials: "include",
                });


                if (!response.ok) throw new Error("Failed to fetch user");

                const result = await response.json();
                user = result.data;

                if (user) {
                    loggedInNavbar.style.display = "block";

                    profilePhoto.src = user.profilePhoto.url || "https://i.pravatar.cc/100?img=12";


                }
            } catch (error) {
                console.log("Error fetching user", error);

            }
            
             const logoutBtn = document.getElementById("logoutButton")
            logoutBtn.addEventListener("click", async (e) => {
                e.preventDefault();

                try {
                    const res = await fetch("http://localhost:3000/api/v1/user/logout", {
                        method: "POST",
                        credentials: "include",
                    });

                    if (!res.ok) throw new Error("Logout failed");

                    const data = await res.json();
                    console.log(data);

                    alert(data.message || "Logged out successfully");


                    window.location.href = "/signup.html";

                } catch (err) {
                    console.error("Logout error:", err);
                    alert("Error logging out. Try again.");
                }
            });
            
        })
    </script>


    <!-- Profile Section -->
    <section class="max-w-3xl mx-auto mt-16 bg-white rounded-lg shadow-md p-8">
        <div class="flex flex-col items-center text-center">
            <div class="relative">
                <img id="profilePhoto"
                    src="https://images.unsplash.com/photo-1603415526960-f7e0328a23b3?auto=format&fit=crop&w=120&h=120&q=80"
                    alt="Profile Photo" class="w-28 h-28 rounded-full border-4 border-indigo-500 object-cover">

                <!-- Camera Icon for Upload -->
                <label for="uploadPhoto"
                    class="absolute bottom-1 right-1 bg-indigo-500 p-2 rounded-full text-white cursor-pointer hover:bg-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 7h2l2-3h10l2 3h2a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V9a2 2 0 012-2z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 11a3 3 0 110 6 3 3 0 010-6z" />
                    </svg>
                </label>
                <input type="file" id="uploadPhoto" class="hidden" accept="image/*">
            </div>

            <h2 class="text-2xl font-semibold mt-4">John Doe</h2>
            <p class="text-gray-500">@johndoe</p>
            <p class="mt-2 text-gray-600">Email: johndoe@example.com</p>
            <p class="mt-1 text-gray-700 font-medium">Total Reviews: <span class="font-semibold">12</span></p>
        </div>

        <!-- Update Profile Form -->
        <form id="updateProfileForm" class="mt-8 space-y-5">
            <div>
                <label for="fullName" class="block text-gray-700 font-medium mb-2">Full Name</label>
                <input type="text" id="fullName" name="fullName" value="John Doe"
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400">
            </div>

            <div>
                <label for="username" class="block text-gray-700 font-medium mb-2">Username</label>
                <input type="text" id="username" name="username" value="johndoe" readonly
                    class="w-full border border-gray-200 bg-gray-100 rounded-lg px-4 py-2 text-gray-500 cursor-not-allowed">
            </div>

            <div>
                <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
                <input type="email" id="email" name="email" value="johndoe@example.com"
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400">
            </div>

            <div class="text-center">
                <button type="submit"
                    class="mt-4 px-6 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">
                    Update Profile
                </button>
            </div>
        </form>

        <!-- Change Password Section -->
        <div class="mt-10 border-t pt-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800 text-center">Change Password</h3>

            <form id="changePasswordForm" class="space-y-5">
                <div>
                    <label for="currentPassword" class="block text-gray-700 font-medium mb-2">Current Password</label>
                    <input type="password" id="currentPassword" name="currentPassword"
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                </div>

                <div>
                    <label for="newPassword" class="block text-gray-700 font-medium mb-2">New Password</label>
                    <input type="password" id="newPassword" name="newPassword"
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                </div>

                <div>
                    <label for="confirmPassword" class="block text-gray-700 font-medium mb-2">Confirm New
                        Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword"
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                </div>

                <div class="text-center">
                    <button type="submit"
                        class="mt-2 px-6 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">
                        Update Password
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- JS: Preview uploaded image -->
    <script>
        const uploadPhoto = document.getElementById('uploadPhoto');
        const profilePhoto = document.getElementById('profilePhoto');

        uploadPhoto.addEventListener('change', async(e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const formData = new FormData()
            formData.append("profilePhoto", file);
        
        
        try {
                const response = await fetch("http://localhost:3000/api/v1/user/profile-photo", {
                method: "PATCH",  
                credentials: "include", 
                body: formData
            });

            if (!response.ok) throw new Error("Failed to update profile photo");

            const data = await response.json();
            const updatedUser = data.data;

            
            profilePhoto.src = updatedUser.profilePhoto.url || "https://i.pravatar.cc/100";

            alert("Profile photo updated successfully!");
        } catch (error) {
            console.error(error);
            alert("Error updating profile photo."); 
        }
    });
        
        const updateProfile = document.getElementById("updateProfileForm")

        updateProfile.addEventListener("submit", async(e) => {
            e.preventDefault()

            const fullName = document.getElementById("fullName").value.trim()
            const email = document.getElementById("email").value.trim()

            if(!fullName || !email){
                alert("Atleast one field is required")
            }

            try {
                const response = await fetch("http://localhost:3000/api/v1/user/update-profile",{
                    method :"PATCH",
                    credentials: "include",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ fullName, email })
                })

                if(!response.ok){
                    throw new Error("Failed to update profile")
                }

                const result = await response.json()
                const updatedUser = result.data

                document.querySelector("h2").textContent = updatedUser.fullName;
                document.querySelector("p.text-gray-500").textContent = "@" + updatedUser.username;
                document.querySelector("p.text-gray-600").textContent = "Email: " + updatedUser.email;

                alert("profile details updated successfully")
            } catch (error) {
                console.error(error);
                alert("Error updating profile");
            }
        })
        

        const updatePassword = document.getElementById("changePasswordForm")

        updatePassword.addEventListener("submit", async(e) =>{
            e.preventDefault()

            const oldPassword = document.getElementById("currentPassword").value
            const newPassword = document.getElementById("newPassword").value
            const confirmPassword = document.getElementById("confirmPassword").value

            if(newPassword !== confirmPassword){
                alert("Confirm new password correctly")
                return;
            }

            try {
                const response = await fetch("http://localhost:3000/api/v1/user/change-password",{
                    method: "PATCH",
                    credentials:"include",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body:JSON.stringify({newPassword,oldPassword})
                })
               
                if(!response.ok){
                    throw new Error("Password upadate failed")
                }

                const result = await response.json()

                alert(result.message || "Password updated successfully")
            } catch (error) {
                console.error(error);
                alert("Error updating password");
            }

        })

        document.addEventListener("DOMContentLoaded", async() =>{

            try {
                const response = await fetch("http://localhost:3000/api/v1/user/current-user",{
                   credentials:"include",
                   method: "GET"
                });

                if(!response.ok){
                    window.location.href = "/signup.html";
                    return;
                }


                const userData = await response.json();
                const currentUser = userData.data;
                

                const profileResponse = await fetch(`http://localhost:3000/api/v1/user/c/${currentUser.username}`, {
                    credentials: "include",
                    method: "GET"
                });           

                if (!profileResponse.ok) {
                    throw new Error("Failed to fetch profile data");
                }

                const profileData = await profileResponse.json();
                const user = profileData.data;

                document.getElementById("profilePhoto").src = user.profilePhoto.url || "https://i.pravatar.cc/100";
                document.getElementById("fullName").value = user.fullName || "";
                document.getElementById("username").value = user.username || "";
                document.getElementById("email").value = user.email || "";
                document.querySelector("h2").textContent = user.fullName || "User";
                document.querySelector("p.text-gray-500").textContent = "@" + (user.username || "");
                document.querySelector("p.text-gray-600").textContent = "Email: " + (user.email || "");
                document.querySelector("p.text-gray-700 span").textContent = user.postCount || 0;

            } catch (error) {
                console.error("Error fetching user:", error);
                alert("Session expired or not logged in.");
                window.location.href = "/signup.html";
            }
        })
    </script>

</body>

</html>