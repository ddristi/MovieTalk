<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Reviews</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

    <!-- Logged-in Navbar -->
    <nav id="loggedInNavbar"
        class="sticky top-0 z-50 w-full bg-white/80 backdrop-blur-md shadow-md transition-all duration-300">
        <div class="max-w-7xl mx-auto flex justify-between items-center px-4 py-2">
            <a href="#" class="flex items-center space-x-2">
                <img src="https://assets.aceternity.com/logo-dark.png" alt="logo" class="w-8 h-8">
                <span class="font-bold text-black">MovieTalk</span>
            </a>
    
            <!-- Desktop Menu -->
            <div class="hidden lg:flex items-center space-x-4">
                <a href="/" class="px-3 py-2 rounded hover:bg-gray-200">Home</a>
                <a href="/myreview.html" class="px-3 py-2 rounded hover:bg-gray-200">My Reviews</a>
    
                <!-- Profile Photo -->
                <div class="relative">
                    <button id="profileButton"
                        class="w-10 h-10 rounded-full overflow-hidden border-2 border-gray-300 focus:outline-none">
                        <img src="https://i.pravatar.cc/100?img=12" alt="Profile" class="w-full h-full object-cover">
                    </button>
    
                    <!-- Dropdown Menu -->
                    <div id="profileDropdown"
                        class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg">
                        <a href="/profile.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Profile</a>
                        <hr class="border-gray-200">
                        <a id="logoutButton" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Logout</a>
                    </div>
                </div>
            </div>
    
            <!-- Mobile Menu Button -->
            <button id="loggedInMobileMenuButton" class="lg:hidden px-3 py-2 rounded bg-gray-200">☰</button>
        </div>
    
        <!-- Mobile Menu -->
        <div id="loggedInMobileMenu" class="hidden flex-col px-4 py-2 space-y-2 bg-white shadow-md lg:hidden">
            <a href="/" class="px-3 py-2 rounded hover:bg-gray-200">Home</a>
            <a href="/myreview.html" class="px-3 py-2 rounded hover:bg-gray-200">My Reviews</a>
            <div class="flex items-center space-x-2 px-3 py-2 border-t border-gray-200 mt-2">
                <img src="https://i.pravatar.cc/100?img=12" alt="Profile" class="w-10 h-10 rounded-full object-cover">
                <span class="text-gray-700 font-semibold">John Doe</span>
            </div>
            <a href="/profile.html" class="px-3 py-2 rounded hover:bg-gray-200">Profile</a>
            <a id="logoutButton" class="px-3 py-2 rounded hover:bg-gray-200">Logout</a>
        </div>
    </nav>
    
    <script>
        // Mobile menu toggle
        const button = document.getElementById('loggedInMobileMenuButton');
        const menu = document.getElementById('loggedInMobileMenu');
        button.addEventListener('click', () => {
            menu.classList.toggle('hidden');
        });

        // Profile dropdown toggle
        const profileButton = document.getElementById('profileButton');
        const profileDropdown = document.getElementById('profileDropdown');
        profileButton.addEventListener('click', () => {
            profileDropdown.classList.toggle('hidden');
        });

        // Close dropdown if clicked outside
        document.addEventListener('click', (e) => {
            if (!profileButton.contains(e.target) && !profileDropdown.contains(e.target)) {
                profileDropdown.classList.add('hidden');
            }
        });
    </script>


        <script>
            document.addEventListener("DOMContentLoaded", async () => {
                const loggedInNavbar = document.getElementById("loggedInNavbar");
                const profilePhoto = document.querySelector("#profileButton img")

                let user = null;

                try {
                    const response = await fetch("http://localhost:3000/api/v1/user/current-user", {
                        method: "GET",
                        credentials: "include",
                    });


                    if (!response.ok) throw new Error("Failed to fetch user");

                    const result = await response.json();
                    user = result.data;

                    if (user) {
                        loggedInNavbar.style.display = "block";

                        profilePhoto.src = user.profilePhoto.url || "https://i.pravatar.cc/100?img=12";


                    }
                } catch (error) {
                    console.log("Error fetching user", error);

                }
               
                 const logoutBtn = document.getElementById("logoutButton")
                logoutBtn.addEventListener("click", async (e) => {
                    e.preventDefault();

                    try {
                        const res = await fetch("http://localhost:3000/api/v1/user/logout", {
                            method: "POST",
                            credentials: "include",
                        });

                        if (!res.ok) throw new Error("Logout failed");

                        const data = await res.json();
                        console.log(data);

                        alert(data.message || "Logged out successfully");


                        window.location.href = "/signup.html";

                    } catch (err) {
                        console.error("Logout error:", err);
                        alert("Error logging out. Try again.");
                    }
                });
                
            })
        </script>

<!-- Profile Section -->
<section class="bg-white shadow-md rounded-lg max-w-3xl mx-auto mt-10 p-6 flex flex-col items-center">
    <img id="profilePhoto" src="https://images.unsplash.com/photo-1603415526960-f7e0328a23b3?ixlib=rb-4.0.3&auto=format&fit=crop&w=120&h=120&q=80"
        alt="User Profile" class="w-28 h-28 rounded-full border-4 border-indigo-500 mb-4 object-cover">
    <h1 id="fullName" class="text-2xl font-semibold">John Doe</h1>
    <p id="username" class="text-gray-500">@johndoe</p>
    <p id="totalReview" class="mt-2 text-gray-700">Total Reviews: <span class="font-semibold">12</span></p>

    <!-- Create Review Button -->
    <a href="/createreview.html"
        class="mt-4 px-6 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">
        + Create Review
    </a>
</section>



<!-- Reviews Section -->
<section class="max-w-3xl mx-auto mt-8 space-y-6" id="reviewsContainer">
    <p class="text-center text-gray-500">Loading reviews...</p>
</section>



 <script>
    document.addEventListener("DOMContentLoaded", async () => {
        const reviewsContainer = document.getElementById("reviewsContainer");

        // Fetch current user and profile
        try {
            const userResp = await fetch("http://localhost:3000/api/v1/user/current-user", {
                credentials: "include",
                method: "GET"
            });

            if (!userResp.ok) throw new Error("Session expired");

            const userData = await userResp.json();
            const currentUser = userData.data;

            const profileResponse = await fetch(`http://localhost:3000/api/v1/user/c/${currentUser.username}`, {
                credentials: "include",
                method: "GET"
            });

            if (!profileResponse.ok) {
                throw new Error("Failed to fetch profile data");
            }

            const profileData = await profileResponse.json();
            const user = profileData.data;

            document.getElementById("fullName").textContent = currentUser.fullName || "";
            document.getElementById("username").textContent = currentUser.username || "";
            document.getElementById("profilePhoto").src = currentUser.profilePhoto?.url || "https://i.pravatar.cc/100";
            document.querySelector("#totalReview span").textContent = user.postCount || 0;

        } catch (err) {
            console.error("Error fetching user:", err);
            alert("Session expired or not logged in.");
            window.location.href = "/signup.html";
            return;
        }

        // Fetch posts
        function createPostCard(post) {
            const card = document.createElement("div");
            card.className = "bg-white shadow-md rounded-lg overflow-hidden";
            card.setAttribute("data-id", post._id);

            card.innerHTML = `
            ${post.movieImage?.url ? `<img src="${post.movieImage.url}" class="w-full h-48 object-cover">` : ""}
            <div class="p-4">
                <h2 class="text-xl font-semibold mb-2">${post.title}</h2>
                <p class="text-gray-700 mb-3 description">${post.description}</p>
                <div class="flex items-center justify-between">
                    <span class="text-yellow-500 font-semibold">★ ${post.rating}</span>
                    <div class="space-x-2">
                        <button class="updateBtn px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Update</button>
                        <button class="deleteBtn px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Delete</button>
                    </div>
                </div>
            </div>
        `;
            // Create and reuse one modal globally
            const updateModal = document.getElementById("updateModal");
            const updateDescription = document.getElementById("updateDescription");
            const cancelUpdate = document.getElementById("cancelUpdate");
            const saveUpdate = document.getElementById("saveUpdate");

            card.querySelector(".updateBtn").addEventListener("click", () => {
                const postId = post._id;
                updateDescription.value = post.description; // prefill
                updateModal.classList.remove("hidden");
                updateModal.classList.add("flex");

                // Cancel button closes modal
                cancelUpdate.onclick = () => {
                    updateModal.classList.add("hidden");
                    updateModal.classList.remove("flex");
                };

                // Save button updates post
                saveUpdate.onclick = async () => {
                    const newDesc = updateDescription.value.trim();
                    if (!newDesc) return alert("Description cannot be empty");

                    try {
                        const res = await fetch(`http://localhost:3000/api/v1/posts/post/${postId}/update-post`, {
                            method: "PATCH",
                            credentials: "include",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ description: newDesc }),
                        });

                        if (!res.ok) throw new Error("Update failed");

                        card.querySelector(".description").textContent = newDesc;

                        // Close modal and notify
                        updateModal.classList.add("hidden");
                        updateModal.classList.remove("flex");
                        alert("Post updated successfully!");
                    } catch (err) {
                        console.error(err);
                        alert("Error updating post");
                    }
                };
            });


 card.querySelector(".deleteBtn").addEventListener("click", async () => {
                if (!confirm("Delete this post?")) return;

                // get the post id safely
                const postId = card.getAttribute("data-id");

                if (!postId) {
                    console.error("Post ID not found for this card!");
                    alert("Error: missing post ID.");
                    return;
                }

                try {
                    const res = await fetch(`http://localhost:3000/api/v1/posts/post/${postId}/delete-post`, {
                        method: "DELETE",
                        credentials: "include"
                    });

                    if (!res.ok) {
                        const errText = await res.text();
                        console.error("Delete error response:", res.status, errText);
                        throw new Error("Delete failed");
                    }

                    card.remove();
                    alert("Post deleted successfully!");
                } catch (err) {
                    console.error(err);
                    alert("Error deleting post");
                }
            });


            return card;
        }

        try {
            const postsResp = await fetch("http://localhost:3000/api/v1/posts/my-posts", {
                credentials: "include",
                method: "GET"
            });
            if (!postsResp.ok) throw new Error("Failed to fetch posts");

            const postsResult = await postsResp.json();
            console.log(postsResult);
            
            let posts = postsResult.data.posts;

            if (!Array.isArray(posts)) posts = posts ? [posts] : [];

            if (posts.length === 0) {
                reviewsContainer.innerHTML = "<p class='text-center text-gray-500'>No reviews yet</p>";
                return;
            }

            reviewsContainer.innerHTML = "";
            posts.reverse().forEach(post => {
                reviewsContainer.prepend(createPostCard(post));
            });

        } catch (err) {
            console.error(err);
            reviewsContainer.innerHTML = "<p class='text-center text-red-500'>Error loading reviews</p>";
        }
    });
</script>

<!-- Update Post Modal -->
<div id="updateModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96">
        <h2 class="text-xl font-semibold mb-4 text-center">Update Review</h2>
        <textarea id="updateDescription" rows="4"
            class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="Edit your description..."></textarea>
        <div class="flex justify-end mt-4 space-x-3">
            <button id="cancelUpdate"
                class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400 transition">Cancel</button>
            <button id="saveUpdate"
                class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition">Save</button>
        </div>
    </div>
</div>


</body>

</html>